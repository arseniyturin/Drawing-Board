<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="user-scalable=no">
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />
	<title>Drawing Board</title>
	<style>
		html, body {
			margin: 0;
			padding: 0;
			color: #444;
			font-family: arial;
		}
		#users {
			padding: 10px;
			border: 1px #f0f0f0 solid;
			position: absolute;
			top: 14px;
			left: 14px;
			z-index: 0;
		}
		#eraser {
      border: 1px #e0e0e0 solid;
      position: absolute;
      top: 14px;
      left: 50%;
      margin-left: -60px;
      display: block;
      z-index: 0;
      text-align: center;
      color: #e0e0e0;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 4px;
      user-select: none;
		}
		.eraser_active {
		  background-color: #5aa2e1;
		}
		.user {
			padding: 4px;
		}
		#blank {
		  position: absolute;
		  width: 100%;
		  height: 100%;
		  top: 0;
		  left: 0;
		  background-color: #000;
		  opacity: .5;
		  visibility: hidden;
		  z-index: 150;
		}
		.userName {
			user-select: none;
			display: inline-block;
			font-size: 13px;
			vertical-align: top;
			margin-top: 3px;
			margin-left: 8px;
			color: #555;
		}
		#changeUsername_field {
		  display: block;
		  position: absolute;
		  top: 45%;
		  left: 50%;
      width: 360px;
      margin-left: -190px;
      padding: 5px 10px;
      border: 1px #767676 solid;
      font-size: 22px;
      border-radius: 4px;
      box-shadow: 0px 2px 7px #5d5d5d;
      box-sizing: border-box;
      z-index: 151;
      visibility: hidden;
		}
		#changeUsername_field:focus {
		  outline: none;
		}
		#canvas {
		  position: absolute;
		  display: block;
		  top: 0;
		  left: 0;
		  width: 100%;
		  height: 100%;
		}
  </style>
  </head>
  <body>
		<canvas id="canvas"></canvas>
  </body>
	<script type="text/javascript">

/*

		actions:
		0 - join
		1 - change username
		2 - change color
		3 - draw
		4 - quit

		data transfer:
		- join
			UTF-8 (action, userid, userid, color, coords(4))
		- change name
			UTF-8 (action, userid, username)
		- change color
			UTF-8 (action, userid, color)
		- draw
			Uint16Array (action, userid, coords(4)) - 12 bytes
		- quit
			Uint16Array (action, userid) - 4 bytes

			data stored:
		- client
			usernames, userids, colors, coords(4)
		- server
			usernames, userids, colors, coords(4)

			Each action broadcasts data to all users

	*/
	const ADDRESS = location.origin.replace(/^http/, 'ws');

	function keepAlive(WS, interval=30000) {
		window.setInterval((e) => {WS.send('');}, interval);
	}

	function createSocket() {
		const WS = new WebSocket(ADDRESS);
		WS.binaryType = 'arraybuffer';
		return WS;
	}

	let WS = createSocket();
	keepAlive(WS);

	// Client connected to server
	WS.onopen = () => { console.log('Connected to Server at:', WS.url) }
	// Server closed the connection or it's crashed
	WS.onclose = () => {
		console.log('Connection is closed');
	}
	// Receive message from server
	WS.onmessage = (event) => {
		if (event.data instanceof ArrayBuffer) {
			let arr = new Uint16Array(event.data);
			drawOthers(arr);
		}
	}

	function initCanvas() {
		const canvas = document.getElementById('canvas');
		const context = canvas.getContext('2d');
		context.canvas.width = canvas.offsetWidth;
		context.canvas.height = canvas.offsetHeight;
		context.lineWidth = 5;
		context.lineCap = 'round';
		context.strokeStyle = '#444444';
		return [canvas, context]
	}

	const [CANVAS, CONTEXT] = initCanvas();

	canvas.addEventListener('touchstart', touchstart);
	canvas.addEventListener('touchmove', draw);
	canvas.addEventListener('mousedown', mousedown);
	canvas.addEventListener('mouseup', mouseup);
	//eraser.addEventListener('click', changeEraserState);

	let coord = {'x': 0, 'y': 0}

	function getPosition(event) {
		coord.x = event.clientX || event.touches[0].clientX;
		coord.y = event.clientY || event.touches[0].clientY;
	}

	function touchstart(event) {
		event.preventDefault();
		getPosition(event);
	}

	// Activate drawing
	function mousedown() {
		getPosition(event);
		canvas.addEventListener('mousemove', draw);
	}
	// Stop drawing with mouse
	function mouseup() {
		canvas.removeEventListener('mousemove', draw);
	}

	function draw() {
		let array = new Uint16Array(4);
		CONTEXT.beginPath();
		CONTEXT.moveTo(coord.x, coord.y);
		array[0] = coord.x;
		array[1] = coord.y;
		getPosition(event);
		CONTEXT.lineTo(coord.x, coord.y);
		array[2] = coord.x;
		array[3] = coord.y;
		CONTEXT.stroke();
		CONTEXT.closePath();
		if (WS.readyState == 1) {
			WS.send(array);
		}

	}

	function drawOthers(coords) {
	  CONTEXT.beginPath();
	  CONTEXT.moveTo(coords[0], coords[1]);
		CONTEXT.lineTo(coords[2], coords[3]);
		CONTEXT.stroke();
	}

	</script>
</html>
